# PelicanLimit ClassAd Attributes

This document describes all attributes published in `PelicanLimit` ClassAds generated by the Pelican AP Manager daemon.

## Overview

`PelicanLimit` ads track transfer statistics and control metrics for each unique (User, Site) pair. These ads support the adaptive control loop that manages job startup limits based on transfer performance.

## Identification and Metadata

### Name
- **Type**: String
- **Description**: Unique identifier for this limit ad, formatted as `pelican-limit-{user}-{site}`
- **Example**: `pelican-limit-alice-UCSD`

### MyType
- **Type**: String
- **Value**: `"PelicanLimit"`
- **Description**: ClassAd type identifier

### UpdateSequenceNumber
- **Type**: Integer
- **Description**: Monotonically increasing sequence number for this ad, used to track updates

### DaemonStartTime
- **Type**: Integer (Unix timestamp)
- **Description**: Time when the Pelican AP Manager daemon started

### ScheddName
- **Type**: String
- **Description**: Name of the HTCondor schedd this daemon is monitoring
- **Example**: `"ap40.uw.osg-htc.org"`

### User
- **Type**: String
- **Description**: HTCondor user name for this limit ad
- **Example**: `"alice"`

### Site
- **Type**: String
- **Description**: Execution site name (from `GLIDEIN_Site` in matched machine ad)
- **Example**: `"UCSD"`

### LastHeardFrom
- **Type**: Integer (Unix timestamp)
- **Description**: Time when this limit state was last updated

### StatsWindowSeconds
- **Type**: Integer
- **Description**: Duration in seconds of the rolling statistics window (typically 600 seconds / 10 minutes)

### StatsWindowStart
- **Type**: Integer (Unix timestamp)
- **Description**: Start time of the current statistics window

### JobEpochWindowSeconds
- **Type**: Integer
- **Description**: Duration in seconds for job epoch retention (typically 86400 seconds / 24 hours)

---

## Window-Level Statistics

Window-level statistics cover the rolling time window (typically the last 10 minutes). These metrics reset as old data ages out of the window.

### Epoch Counts (Window)

#### WindowEpochSuccessCount
- **Type**: Integer
- **Description**: Number of unique job epochs with at least one successful file transfer in the window
- **Unit of Measurement**: Epochs

#### WindowEpochFailureCount
- **Type**: Integer
- **Description**: Number of unique job epochs with at least one failed file transfer in the window
- **Unit of Measurement**: Epochs

#### WindowEpochTotalCount
- **Type**: Integer
- **Description**: Total number of unique job epochs in the window (success + failure)
- **Unit of Measurement**: Epochs

### Byte Counts (Window)

#### WindowEpochSuccessBytes
- **Type**: Integer
- **Description**: Total bytes successfully transferred in the window
- **Unit of Measurement**: Bytes

#### WindowEpochFailureBytes
- **Type**: Integer
- **Description**: Total bytes attempted but failed to transfer in the window
- **Unit of Measurement**: Bytes

#### WindowEpochTotalBytes
- **Type**: Integer
- **Description**: Total bytes attempted (success + failure) in the window
- **Unit of Measurement**: Bytes

### File Durations (Window)

These track the sum of transfer durations across **all retry attempts** for each file.

#### WindowFileSuccessDurationSec
- **Type**: Float
- **Description**: Sum of all successful transfer durations (including retries) in the window
- **Unit of Measurement**: Seconds
- **Note**: Includes time spent on all retry attempts, not just the final successful attempt

#### WindowFileFailureDurationSec
- **Type**: Float
- **Description**: Sum of all failed transfer durations in the window
- **Unit of Measurement**: Seconds

#### WindowFileTotalDurationSec
- **Type**: Float
- **Description**: Total transfer duration (success + failure) in the window
- **Unit of Measurement**: Seconds

### Epoch Wall-Clock Times (Window)

Wall-clock time measures the actual elapsed time for an epoch, accounting for parallel file transfers.

#### WindowEpochSuccessWallClockSec
- **Type**: Float
- **Description**: Sum of wall-clock time spans (earliest start to latest end) for successful epochs in the window
- **Unit of Measurement**: Seconds
- **Calculation**: For each successful epoch, computes the span from the earliest transfer start time to the latest transfer end time

#### WindowEpochFailureWallClockSec
- **Type**: Float
- **Description**: Sum of wall-clock time spans for failed epochs in the window
- **Unit of Measurement**: Seconds

#### WindowEpochTotalWallClockSec
- **Type**: Float
- **Description**: Total wall-clock time (success + failure) in the window
- **Unit of Measurement**: Seconds

#### WindowEpochAvgWallClockSuccessSec
- **Type**: Float
- **Description**: Average wall-clock time per successful epoch in the window
- **Unit of Measurement**: Seconds
- **Calculation**: `WindowEpochSuccessWallClockSec / WindowEpochSuccessCount`

#### WindowEpochAvgWallClockFailureSec
- **Type**: Float
- **Description**: Average wall-clock time per failed epoch in the window
- **Unit of Measurement**: Seconds
- **Calculation**: `WindowEpochFailureWallClockSec / WindowEpochFailureCount`

### Window Success Rate

#### WindowSuccessRate
- **Type**: Float (0.0 to 1.0)
- **Description**: Ratio of successful epochs to total epochs in the window
- **Calculation**: `WindowEpochSuccessCount / WindowEpochTotalCount`

### Window Transfer Rates

#### WindowRateAvgBytesPerSec
- **Type**: Float
- **Description**: Average transfer rate across all successful epochs in the window
- **Unit of Measurement**: Bytes per second

#### WindowRateMedianBytesPerSec
- **Type**: Float
- **Description**: Median transfer rate across all successful epochs in the window
- **Unit of Measurement**: Bytes per second

#### WindowRateP10BytesPerSec
- **Type**: Float
- **Description**: 10th percentile transfer rate (slower epochs)
- **Unit of Measurement**: Bytes per second

#### WindowRateP90BytesPerSec
- **Type**: Float
- **Description**: 90th percentile transfer rate (faster epochs)
- **Unit of Measurement**: Bytes per second

### Window File Counts

#### WindowEpochSuccessFiles
- **Type**: Integer
- **Description**: Total number of individual files successfully transferred in the window
- **Unit of Measurement**: Files

#### WindowEpochFailureFiles
- **Type**: Integer
- **Description**: Total number of individual file transfers that failed in the window
- **Unit of Measurement**: Files

#### WindowEpochTotalFiles
- **Type**: Integer
- **Description**: Total number of file transfer attempts (success + failure) in the window
- **Unit of Measurement**: Files

---

## Cumulative File-Level Statistics

These track **individual file transfers** since daemon startup. Each file transfer (including retries) is counted separately.

### Total File Counts

#### TotalFileSuccessCount
- **Type**: Integer
- **Description**: Total number of successful file transfers since daemon start
- **Unit of Measurement**: File transfers

#### TotalFileFailureCount
- **Type**: Integer
- **Description**: Total number of failed file transfers since daemon start
- **Unit of Measurement**: File transfers

#### TotalFileCount
- **Type**: Integer
- **Description**: Total number of file transfer attempts (success + failure) since daemon start
- **Unit of Measurement**: File transfers

### Total File Bytes

#### TotalFileSuccessBytes
- **Type**: Integer
- **Description**: Total bytes successfully transferred since daemon start
- **Unit of Measurement**: Bytes

#### TotalFileFailureBytes
- **Type**: Integer
- **Description**: Total bytes that failed to transfer since daemon start
- **Unit of Measurement**: Bytes

#### TotalFileBytes
- **Type**: Integer
- **Description**: Total bytes attempted (success + failure) since daemon start
- **Unit of Measurement**: Bytes

### Total File Durations

#### TotalFileSuccessDurationSec
- **Type**: Float
- **Description**: Sum of all successful file transfer durations since daemon start
- **Unit of Measurement**: Seconds

#### TotalFileFailureDurationSec
- **Type**: Float
- **Description**: Sum of all failed file transfer durations since daemon start
- **Unit of Measurement**: Seconds

#### TotalFileDurationSec
- **Type**: Float
- **Description**: Total file transfer duration (success + failure) since daemon start
- **Unit of Measurement**: Seconds

### Total File Success Rate

#### TotalFileSuccessRate
- **Type**: Float (0.0 to 1.0)
- **Description**: Overall success rate for file transfers since daemon start
- **Calculation**: `TotalFileSuccessCount / TotalFileCount`

---

## Cumulative Epoch-Level Statistics

These track **unique job epochs** since daemon startup. Each epoch (identified by ClusterID, ProcID, RunInstanceID) is counted once, regardless of how many files it transferred.

### Total Epoch Counts

#### TotalEpochSuccessCount
- **Type**: Integer
- **Description**: Total number of unique epochs with at least one successful file transfer since daemon start
- **Unit of Measurement**: Epochs

#### TotalEpochFailureCount
- **Type**: Integer
- **Description**: Total number of unique epochs with at least one failed file transfer since daemon start
- **Unit of Measurement**: Epochs
- **Note**: An epoch can be both successful and failed if it had both successful and failed file transfers

#### TotalEpochCount
- **Type**: Integer
- **Description**: Total number of unique epochs processed since daemon start
- **Unit of Measurement**: Epochs

### Total Epoch Wall-Clock Times

#### TotalEpochSuccessWallClockSec
- **Type**: Float
- **Description**: Cumulative wall-clock time for all successful epochs since daemon start
- **Unit of Measurement**: Seconds

#### TotalEpochFailureWallClockSec
- **Type**: Float
- **Description**: Cumulative wall-clock time for all failed epochs since daemon start
- **Unit of Measurement**: Seconds

#### TotalEpochWallClockSec
- **Type**: Float
- **Description**: Total wall-clock time for all epochs since daemon start
- **Unit of Measurement**: Seconds
- **Calculation**: `TotalEpochSuccessWallClockSec + TotalEpochFailureWallClockSec`

---

## Window-Based Per-Epoch Averages

These statistics are computed from the transfer window (10 minutes) on a per-epoch basis.

### WindowAvgFilesPerEpoch
- **Type**: Float
- **Description**: Average number of files transferred per successful epoch in the transfer window
- **Unit of Measurement**: Files per epoch
- **Calculation**: Total successful files / successful epoch count (from 10-minute window)

### WindowAvgBytesPerEpoch
- **Type**: Float
- **Description**: Average bytes transferred per successful epoch in the transfer window
- **Unit of Measurement**: Bytes per epoch
- **Calculation**: Total successful bytes / successful epoch count (from 10-minute window)

### WindowAvgTransferTimeSec
- **Type**: Float
- **Description**: Average wall-clock time per successful transfer epoch in the transfer window
- **Unit of Measurement**: Seconds per epoch
- **Calculation**: Total successful wall-clock seconds / successful epoch count (from 10-minute window)
- **Note**: This is the numerator for StageInPercent calculation

---

## Job Window Per-Epoch Averages

These statistics are computed from the job window (24 hours) on a per-epoch basis.

### JobWindowAvgExecutionTimeSec
- **Type**: Float
- **Description**: Average execution time per job epoch with non-zero execution duration in the job window
- **Unit of Measurement**: Seconds per epoch
- **Calculation**: JobWindowTotalExecutionTimeSec / JobWindowExecutionCount (from 24-hour window)
- **Note**: This is the denominator for StageInPercent calculation; based on ActivationExecutionDuration (computation-only time)

---

## Control Loop Metrics

### CapacityGBPerMin
- **Type**: Float
- **Description**: Current rate limit capacity for this user+site in GB per minute
- **Unit of Measurement**: Gigabytes per minute

### ErrorRate
- **Type**: Float (0.0 to 1.0)
- **Description**: Current error rate (1.0 - WindowSuccessRate)
- **Calculation**: `1.0 - WindowSuccessRate`

### StageInPercent
- **Type**: Float (0.0 to 100.0)
- **Description**: Percentage of job execution time spent on stage-in transfers, used as the cost metric for the control loop
- **Unit of Measurement**: Percent
- **Calculation**: `(WindowAvgTransferTimeSec / JobWindowAvgExecutionTimeSec) Ã— 100`
- **Data Sources**: 
  - Numerator: `WindowAvgTransferTimeSec` - Average successful transfer wall-clock duration per epoch from the 10-minute rolling window
  - Denominator: `JobWindowAvgExecutionTimeSec` - Average execution time per job epoch from 24-hour job window
- **Note**: Uses `ActivationExecutionDuration` (computation time only) as the baseline, not total job runtime. Both numerator and denominator are now exposed as standalone attributes for easier debugging.

### JobWindowJobEpochs
- **Type**: Integer
- **Description**: Number of **job completion events** observed in the **24-hour historical window** for this user+site pair
- **Data Source**: HTCondor job history query (`FetchJobEpochs`) stored in `JobEpochs` map
- **Note**: Job completion events may not be captured for all jobs that performed transfers

### JobWindowTransferEpochs
- **Type**: Integer
- **Description**: Number of epochs with **transfer records** in the **24-hour historical window**
- **Data Source**: Transfer events stored in `EpochBuckets`
- **Note**: This represents all epochs that had file transfers, regardless of job completion status

### JobWindowEpochsWithBoth
- **Type**: Integer
- **Description**: Number of epochs with both job runtime and transfer data in the **24-hour historical window**
- **Note**: This is the subset of epochs that have both job completion records and transfer records, which can be used for accurate stage-in percentage calculations

### JobWindowActivationCount
- **Type**: Integer
- **Description**: Number of **job completion events with non-zero total runtime** in the **24-hour historical window**
- **Data Source**: Job epochs from `JobEpochs` map where `RuntimeSec > 0`
- **Runtime Derivation**: From HTCondor ClassAd attribute `ActivationDuration` (preferred), which represents the full job runtime including setup, stagein, execution, stageout, and teardown. Falls back to `RemoteWallClockTime` or `CommittedSlotTime` if `ActivationDuration` is not available.
- **Note**: This counts job epochs that have valid total runtime data

### JobWindowTotalActivationTimeSec
- **Type**: Float
- **Description**: Sum of total runtime across all job completion events in the **24-hour historical window**
- **Unit of Measurement**: Seconds
- **Data Source**: Sum of `RuntimeSec` (from `ActivationDuration`) from all `JobEpochs` entries for this user+site pair
- **Note**: Represents total job runtime including all phases (setup + stagein + execution + stageout + teardown)

### JobWindowExecutionCount
- **Type**: Integer
- **Description**: Number of **job completion events with non-zero execution time** in the **24-hour historical window**
- **Data Source**: Job epochs from `JobEpochs` map where `ExecutionDurationSec > 0`
- **Execution Time Derivation**: From HTCondor ClassAd attribute `ActivationExecutionDuration`, which represents only the actual execution time (excluding setup, stagein, stageout, and teardown)
- **Note**: This may be zero or missing if job setup failed. Used for calculating the cost metric.

### JobWindowTotalExecutionTimeSec
- **Type**: Float
- **Description**: Sum of execution time across all job completion events in the **24-hour historical window**
- **Unit of Measurement**: Seconds
- **Data Source**: Sum of `ExecutionDurationSec` (from `ActivationExecutionDuration`) from all `JobEpochs` entries for this user+site pair
- **Note**: Represents computation-only time, excluding setup/stagein/stageout/teardown. This is used as the denominator for the `StageInPercent` cost metric.

### JobCostGB
- **Type**: Float
- **Description**: Estimated "cost" in GB for running a job based on data transfer overhead. Calculated as the average sandbox size for the user+site pair if at least 5 unique sandboxes are available in the stats window; otherwise defaults to the configured `DefaultJobCostGB` (default: 10 GB).
- **Unit of Measurement**: Gigabytes
- **Calculation**: Average of unique sandbox sizes (bytes converted to GB) for user+site pair with minimum 5 samples
- **Data Source**: `SandboxSize` from recent transfer history in the stats window

### ControlErrorBand
- **Type**: String
- **Values**: `"green"`, `"yellow"`, `"red"`
- **Description**: Error rate classification band
  - **Green**: Error rate below `ErrorGreenThreshold` (healthy)
  - **Yellow**: Error rate between `ErrorGreenThreshold` and `ErrorYellowThreshold` (warning)
  - **Red**: Error rate above `ErrorYellowThreshold` (critical)

### ControlCostBand
- **Type**: String
- **Values**: `"green"`, `"yellow"`, `"red"`
- **Description**: Cost classification band
  - **Green**: Stage-in percentage below `CostGreenThresholdPercent` (healthy)
  - **Yellow**: Stage-in percentage between `CostGreenThresholdPercent` and `CostYellowThresholdPercent` (warning)
  - **Red**: Stage-in percentage above `CostYellowThresholdPercent` (critical)

---

## Rate Limit Information

These fields are only present if the limit manager is active.

### TargetJobsPerMin
- **Type**: Float
- **Description**: Target job startup rate in jobs per minute, calculated from `CapacityGBPerMin / JobCostGB`
- **Unit of Measurement**: Jobs per minute
- **Calculation**: `CapacityGBPerMin / JobCostGB`
- **Note**: This represents the desired job startup rate if a limit were to be installed based on current capacity

### MeasuredJobsPerMin
- **Type**: Float
- **Description**: Measured input sandbox transfer rate over the transfer window (typically 10 minutes)
- **Unit of Measurement**: Sandboxes per minute
- **Calculation**: `UniqueInputSandboxes / (TransferWindowSeconds / 60)`
- **Data Source**: Count of unique input sandbox names with download direction in the rolling transfer window
- **Note**: Represents actual job startup activity based on input data transfers observed in the recent window

### ControlRateLimit
- **Type**: Integer
- **Description**: Current job startup rate limit (jobs per time window)
- **Unit of Measurement**: Jobs

### ControlRateWindow
- **Type**: Integer
- **Description**: Time window in seconds for the rate limit
- **Unit of Measurement**: Seconds

### ControlLimitActive
- **Type**: Boolean
- **Description**: Whether the rate limit is currently active for this user+site pair

### ControlLimitUUID
- **Type**: String
- **Description**: UUID of the active HTCondor startup limit, if one exists
- **Note**: Only present when a limit has been created for this user+site pair

---

## Key Relationships and Formulas

### Epoch vs File Metrics

- **Epoch metrics** count unique job executions (ClusterID.ProcID.RunInstanceID)
- **File metrics** count individual file transfers (which may be retried)
- An epoch with 4 files will have:
  - Epoch count: 1
  - File count: 4 (or more if any files were retried)

### Window vs Total Metrics

- **Window metrics** (prefixed with `Window`) cover a rolling time window (typically 10 minutes)
- **Total metrics** (prefixed with `Total`) are cumulative since daemon startup
- Window metrics are useful for current system state and control decisions
- Total metrics provide historical context

### Success Rates

- **WindowSuccessRate**: Current transfer health (rolling window)
- **TotalFileSuccessRate**: Overall reliability since daemon start
- Control decisions primarily use WindowSuccessRate for responsiveness

### Wall-Clock Time

Wall-clock time measures actual elapsed time, accounting for parallel transfers:
- Multiple files transferring simultaneously contribute only their span (start to end) rather than the sum of individual durations
- Useful for understanding actual user wait time
- Always less than or equal to the sum of individual file durations

---

## Example Ad

```
MyType = "PelicanLimit"
Name = "pelican-limit-alice-UCSD"
User = "alice"
Site = "UCSD"
WindowEpochSuccessCount = 42
WindowEpochFailureCount = 3
WindowSuccessRate = 0.933
WindowEpochSuccessWallClockSec = 523.5
TotalFileSuccessCount = 15432
TotalFileCount = 15521
TotalEpochCount = 3456
ControlErrorBand = "green"
ControlCostBand = "yellow"
CapacityGBPerMin = 150.0
```

This ad indicates a healthy user+site pair with 93.3% success rate in the current window, good control band classification, and substantial historical activity.
